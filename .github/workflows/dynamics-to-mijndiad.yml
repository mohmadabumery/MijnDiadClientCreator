name: Dynamics → MijnDiAd Automation (Auto-Login)

on:
  workflow_dispatch:
    inputs:
      dynamics_json:
        description: "JSON payload from Power Automate"
        required: true
        type: string

jobs:
  run-automation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Add Playwright package to project
        run: |
          dotnet add MijnDiadAutomation package Microsoft.Playwright --version 1.43.0
          dotnet restore MijnDiadAutomation
          dotnet build MijnDiadAutomation

      - name: Install Playwright CLI and Browsers
        run: |
          dotnet tool install --global Microsoft.Playwright.CLI --version 1.2.3
          export PATH="$PATH:/home/runner/.dotnet/tools"
          playwright install

      - name: Run MijnDiAd Automation with Auto-Login
        run: |
          dotnet run --project MijnDiadAutomation -- --json '${{ inputs.dynamics_json }}'
        env:
          MIJNDIAD_USERNAME: ${{ secrets.MIJNDIAD_USERNAME }}
          MIJNDIAD_PASSWORD: ${{ secrets.MIJNDIAD_PASSWORD }}
          MIJNDIAD_TOTP_SECRET: ${{ secrets.MIJNDIAD_TOTP_SECRET }}
          MIJNDIAD_TENANT: ${{ secrets.MIJNDIAD_TENANT }}

      - name: Workflow Summary
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "✓ Client successfully created in MijnDiAd EPD"
          else
            echo "❌ Failed to create client - check logs above"
          fi
