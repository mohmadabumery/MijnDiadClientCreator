name: Dynamics to MijnDiAd

on:
  workflow_dispatch:
    inputs:
      dynamics_json:
        description: 'Client JSON payload from Power Automate'
        required: true
        type: string

jobs:
  login:
    runs-on: ubuntu-latest
    outputs:
      session_cookie: ${{ steps.login-out.outputs.session_cookie }}
      xsrf_token: ${{ steps.login-out.outputs.xsrf_token }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Login to MijnDiAd
        id: login-out
        run: |
          dotnet build MijnDiAdClientCreator.csproj
          dotnet run --project MijnDiAdClientCreator.csproj -- --json '{}'
        env:
          MIJNDIAD_TENANT: ${{ secrets.MIJNDIAD_TENANT }}
          MIJNDIAD_USERNAME: ${{ secrets.MIJNDIAD_USERNAME }}
          MIJNDIAD_PASSWORD: ${{ secrets.MIJNDIAD_PASSWORD }}
          MIJNDIAD_TOTP_SECRET: ${{ secrets.MIJNDIAD_TOTP_SECRET }}
        continue-on-error: false

      - name: Export login outputs
        run: |
